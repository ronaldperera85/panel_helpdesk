<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helpdesk Icarosoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #121629;       
            --card-bg: #232946;       
            --color-reciente: #00e676;
            --color-atencion: #ffea00;
            --color-leve: #ff9100;
            --color-significativo: #ff1744;
            --color-excedido: #d500f9;
        }

        body {
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* --- AJUSTE TV: Zoom out para que quepa todo --- */
            zoom: 0.85; /* Ajusta este número si sigue muy grande (0.8) o muy chico (0.9) */
            height: 100vh; /* Ocupar toda la altura */
            overflow: hidden; /* Evitar scrollbars */
        }

        .text-glow {
            color: #ffffff !important;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
            font-weight: 700;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: #ffffff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .card-custom {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }

        .card-title {
            color: #a0aec0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .big-number {
            font-size: 3rem; /* Reducido un poco para TV */
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* --- LISTA A 2 COLUMNAS (GRID) --- */
        .agent-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            height: 420px; /* Ajuste de altura para TV */
            overflow: hidden; 
            align-content: start;
        }

        .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.08); 
            background-color: rgba(255,255,255,0.02); 
            border-radius: 8px; 
        }

        .more-items-indicator {
            grid-column: span 2; 
            text-align: center;
            background-color: var(--color-atencion);
            color: #000;
            font-weight: 800;
            padding: 8px;
            border-radius: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .agent-name {
            font-weight: 600;
            font-size: 1rem;
            color: #ffffff;
        }

        .agent-status {
            font-size: 0.85rem;
            color: #e2e8f0 !important;
            font-weight: 500;
            opacity: 0.9;
        }

        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 15px;
            box-shadow: 0 0 8px currentColor;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .text-reciente { color: var(--color-reciente) !important; }
        .text-atencion { color: var(--color-atencion) !important; }
        .text-leve { color: var(--color-leve) !important; }
        .text-significativo { color: var(--color-significativo) !important; }
        .text-excedido { color: var(--color-excedido) !important; }

        .bg-reciente { background-color: var(--color-reciente); color: #000; }
        .bg-atencion { background-color: var(--color-atencion); color: #000; }
        .bg-leve { background-color: var(--color-leve); color: #000; }
        .bg-significativo { background-color: var(--color-significativo); color: #fff; }
        .bg-excedido { background-color: var(--color-excedido); color: #fff; }

        .badge-custom {
            font-weight: 800;
            letter-spacing: 0.5px;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>

<!-- Padding reducido a p-3 -->
<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0 text-white"><i class="fas fa-chart-pie me-2"></i>ICAROSoft, C.A. / Helpdesk</h3>
        <div class="text-end">
            <div id="reloj" class="h4 m-0 text-white fw-bold">00:00:00</div>
            <small id="last-update" class="text-white-50" style="font-size: 0.75rem;">Conectando...</small>
        </div>
    </div>

    <!-- FILA 1: KPIs -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card card-custom p-3 h-100">
                <div class="card-title">Asignados</div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="big-number" id="kpi-asignados">--</div>
                    <i class="fas fa-headset fa-2x text-white-50 mb-2"></i>
                </div>
                <small class="text-reciente fw-bold">Chats activos ahora</small>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card card-custom p-3 h-100">
                <div class="card-title">Total Abiertos</div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="big-number" id="kpi-abiertos">--</div>
                    <i class="fas fa-folder-open fa-2x text-white-50 mb-2"></i>
                </div>
                <small class="text-white-50">Acumulado del día</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-custom p-3 h-100">
                <div class="card-title">Esperando Cliente</div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="big-number" id="kpi-espera">--</div>
                    <i class="fas fa-user-clock fa-2x text-white-50 mb-2"></i>
                </div>
                <small class="text-atencion fw-bold" style="filter: brightness(1.2);">Requiere respuesta</small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-custom p-3 h-100" style="border-bottom: 4px solid var(--color-excedido);">
                <div class="card-title text-white">Retraso Crítico (>2h)</div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="big-number" id="kpi-criticos">--</div>
                    <i class="fas fa-triangle-exclamation fa-2x text-white-50 mb-2"></i>
                </div>
                <small class="text-excedido fw-bold">Atención Inmediata</small>
            </div>
        </div>
    </div>

    <!-- FILA 2 -->
    <div class="row">
        <!-- 
             IMPORTANTE PARA TV:
             Usamos col-8 y col-4 (sin 'lg') para forzar la estructura
             y que nunca se ponga una debajo de la otra.
        -->
        <div class="col-8 mb-3">
            <div class="card card-custom p-3 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom border-secondary">
                    <h5 class="m-0 text-white fw-bold">Estado de Tickets</h5>
                    <div class="d-none d-xl-block" style="font-size: 0.75rem;">
                        <span class="me-3 text-reciente"><i class="fas fa-circle"></i> <10m</span>
                        <span class="me-3 text-atencion"><i class="fas fa-circle"></i> 10-20m</span>
                        <span class="me-3 text-leve"><i class="fas fa-circle"></i> 20-30m</span>
                        <span class="me-3 text-significativo"><i class="fas fa-circle"></i> 30-40m</span>
                        <span class="text-excedido"><i class="fas fa-circle"></i> >40m</span>
                    </div>
                </div>
                <ul class="agent-list" id="ticket-list">
                    <li class="text-center mt-5 text-muted">
                        <div class="spinner-border text-light" role="status"></div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-4 mb-3">
            <!-- AGREGADO: d-flex flex-column justify-content-center -->
            <!-- Esto centra todo el bloque verticalmente para aprovechar el espacio -->
            <div class="card card-custom p-3 h-100 d-flex flex-column justify-content-center">
                
                <h5 class="mb-3 text-white fw-bold">Métricas de Retraso</h5>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-glow">> 120 min</span>
                        <span id="bar-val-120" class="metric-value">0</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #334155; border-radius: 5px;">
                        <div id="bar-120" class="progress-bar bg-excedido" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-glow">60 - 120 min</span>
                        <span id="bar-val-60" class="metric-value">0</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #334155; border-radius: 5px;">
                        <div id="bar-60" class="progress-bar bg-excedido" style="width: 0%; opacity: 0.7;"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-glow">30 - 40 min</span>
                        <span id="bar-val-30" class="metric-value">0</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #334155; border-radius: 5px;">
                        <div id="bar-30" class="progress-bar bg-significativo" style="width: 0%"></div>
                    </div>
                </div>

                 <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-glow">< 10 min</span>
                        <span id="bar-val-10" class="metric-value">0</span>
                    </div>
                    <div class="progress" style="height: 10px; background: #334155; border-radius: 5px;">
                        <div id="bar-10" class="progress-bar bg-reciente" style="width: 0%"></div>
                    </div>
                </div>

                <!-- CAMBIO AQUI: Se cambió 'mt-auto' por 'mt-3' -->
                <div class="mt-3 pt-3 border-top border-secondary text-center">
                    <small class="text-white-50 d-block mb-1">Sucursal Conectada</small>
                    <h2 id="info-sucursal" class="text-white fw-bold mb-2">...</h2>
                    <div class="badge bg-success bg-opacity-25 text-success border border-success px-3">ONLINE</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const getLocalApiUrl = () => `data.php?_t=${Date.now()}`;

    function getStyles(categoryKey) {
        switch(categoryKey) {
            case 'menos_10_minutos': return { color: 'text-reciente', badge: 'bg-reciente' };
            case 'de_10_a_20_minutos': return { color: 'text-atencion', badge: 'bg-atencion' };
            case 'de_20_a_30_minutos': return { color: 'text-leve', badge: 'bg-leve' };
            case 'de_30_a_40_minutos': return { color: 'text-significativo', badge: 'bg-significativo' };
            case 'de_40_a_60_minutos': 
            case 'de_60_a_120_minutos': 
            case 'mas_de_120_minutos': return { color: 'text-excedido', badge: 'bg-excedido' };
            default: return { color: 'text-white', badge: 'bg-secondary' };
        }
    }

    function formatLabel(key) {
        return key.replace(/_/g, ' ').replace('de ', '').toUpperCase();
    }

    async function fetchData() {
        const statusLabel = document.getElementById('last-update');
        try {
            statusLabel.innerHTML = '<span class="text-warning">Sincronizando...</span>';
            const response = await fetch(getLocalApiUrl());
            if (!response.ok) throw new Error(`Error Servidor: ${response.status}`);
            const data = await response.json();
            if(data.error) throw new Error(data.message || 'Error API');

            renderDashboard(data);
            
            statusLabel.innerHTML = '<span class="text-success fw-bold">Actualizado: ' + new Date().toLocaleTimeString() + '</span>';
        } catch (error) {
            console.error('Error:', error);
            statusLabel.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
        }
    }

    function renderDashboard(data) {
        if(!data || !data.resumen_general) return;

        const resumen = data.resumen_general;

        document.getElementById('kpi-asignados').innerText = resumen.chat_asignados || 0;
        document.getElementById('kpi-abiertos').innerText = resumen.chat_abiertos || 0;
        document.getElementById('kpi-espera').innerText = resumen.chat_en_espera_del_cliente || 0;
        document.getElementById('kpi-criticos').innerText = resumen.chat_tiempo_espera_mas_120min || 0;
        
        if(resumen.info_consulta?.sucursal) {
            document.getElementById('info-sucursal').innerText = resumen.info_consulta.sucursal.toUpperCase();
        }

        const MAX_SCALE = 20; 
        const updateBar = (id, val) => {
            document.getElementById(`bar-val-${id}`).innerText = val;
            let percent = (val / MAX_SCALE) * 100;
            if (percent > 100) percent = 100;
            document.getElementById(`bar-${id}`).style.width = `${percent}%`;
        };

        updateBar('120', resumen.chat_tiempo_espera_mas_120min || 0);
        updateBar('60', resumen.chat_tiempo_espera_120min || 0);
        updateBar('30', resumen.chat_tiempo_espera_30min || 0);
        updateBar('10', resumen.chat_tiempo_espera_menos_10min || 0);

        const listContainer = document.getElementById('ticket-list');
        let htmlContent = '';
        const detalles = data.detalle_por_tiempo_espera;

        const MAX_ITEMS_ON_SCREEN = 10; 
        let currentCount = 0;
        let limitReached = false;

        for (const [key, tickets] of Object.entries(detalles)) {
            if(key === 'en_espera_del_cliente') continue; 
            if(limitReached) break;

            const styles = getStyles(key);
            const label = formatLabel(key);

            if (Array.isArray(tickets) && tickets.length > 0) {
                for (const ticket of tickets) {
                    if (currentCount >= MAX_ITEMS_ON_SCREEN) {
                        limitReached = true;
                        break;
                    }
                    htmlContent += `
                        <li class="agent-item">
                            <div class="d-flex align-items-center">
                                <span class="status-dot ${styles.color}"></span>
                                <div>
                                    <div class="agent-name text-truncate" style="max-width: 150px;">
                                        ${ticket.nombre_cliente || 'Desconocido'}
                                    </div>
                                    <div class="agent-status small">
                                        <i class="fas fa-id-card me-1"></i> ${ticket.numero_cliente || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge badge-custom ${styles.badge} text-dark" style="font-size: 0.65rem;">
                                    ${label}
                                </span>
                            </div>
                        </li>
                    `;
                    currentCount++;
                }
            }
        }
        
        if (limitReached) {
            htmlContent += `
                <li class="more-items-indicator">
                    <i class="fas fa-ellipsis-h me-2"></i> HAY MÁS EN COLA
                </li>
            `;
        }

        if(htmlContent === '' && !limitReached) {
            htmlContent = `
                <li class="text-center p-5 text-muted" style="grid-column: span 2;">
                    <i class="fas fa-check-circle fa-2x mb-3 d-block"></i>
                    Excelente. No hay tickets con retraso.
                </li>`;
        }
        
        listContainer.innerHTML = htmlContent;
    }

    setInterval(() => {
        document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
    }, 1000);

    fetchData(); 
    setInterval(fetchData, 5000); 
</script>
</body>
</html>